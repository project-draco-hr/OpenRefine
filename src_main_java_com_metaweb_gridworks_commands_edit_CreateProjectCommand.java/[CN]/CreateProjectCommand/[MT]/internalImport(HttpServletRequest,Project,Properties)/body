{
  MultipartParser parser=new MultipartParser(request,1024 * 1024 * 1024);
  if (parser != null) {
    Part part=null;
    String url=null;
    int limit=-1;
    int skip=0;
    if (options.containsKey("limit")) {
      String s=options.getProperty("limit");
      try {
        limit=Integer.parseInt(s);
      }
 catch (      Exception e) {
      }
    }
    if (options.containsKey("skip")) {
      String s=options.getProperty("skip");
      try {
        skip=Integer.parseInt(s);
      }
 catch (      Exception e) {
      }
    }
    while ((part=parser.readNextPart()) != null) {
      if (part.isFile()) {
        FilePart filePart=(FilePart)part;
        BufferedInputStream inputStream=new BufferedInputStream(filePart.getInputStream());
        Importer importer=guessImporter(options,null,filePart.getFileName());
        if (importer.takesReader()) {
          byte[] bytes=new byte[1024 * 4];
{
            inputStream.mark(bytes.length);
            inputStream.read(bytes);
            inputStream.reset();
          }
          CharsetDetector detector=new CharsetDetector();
          detector.setDeclaredEncoding("utf8");
          Reader reader=null;
          CharsetMatch[] charsetMatches=detector.setText(bytes).detectAll();
          for (          CharsetMatch charsetMatch : charsetMatches) {
            try {
              reader=new InputStreamReader(inputStream,charsetMatch.getName());
              options.setProperty("encoding",charsetMatch.getName());
              options.setProperty("encoding_confidence",Integer.toString(charsetMatch.getConfidence()));
              Gridworks.log("Best encoding guess: " + charsetMatch.getName() + " [confidence: "+ charsetMatch.getConfidence()+ "]");
              break;
            }
 catch (            UnsupportedEncodingException e) {
            }
          }
          if (reader == null) {
            reader=new InputStreamReader(inputStream);
          }
          try {
            importer.read(reader,project,options,skip,limit);
          }
  finally {
            reader.close();
          }
        }
 else {
          try {
            importer.read(inputStream,project,options,skip,limit);
          }
  finally {
            inputStream.close();
          }
        }
      }
 else       if (part.isParam()) {
        ParamPart paramPart=(ParamPart)part;
        String paramName=paramPart.getName();
        if (paramName.equals("raw-text")) {
          StringReader reader=new StringReader(paramPart.getStringValue());
          try {
            new TsvCsvImporter().read(reader,project,options,skip,limit);
          }
  finally {
            reader.close();
          }
        }
 else         if (paramName.equals("url")) {
          url=paramPart.getStringValue();
        }
 else {
          options.put(paramName,paramPart.getStringValue());
        }
      }
    }
    if (url != null && url.length() > 0) {
      internalImportURL(request,project,options,url,skip,limit);
    }
  }
}
