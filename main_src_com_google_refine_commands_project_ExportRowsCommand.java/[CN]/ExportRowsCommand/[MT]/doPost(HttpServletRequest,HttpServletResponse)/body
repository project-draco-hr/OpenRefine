{
  ProjectManager.singleton.setBusy(true);
  try {
    Project project=getProject(request);
    Engine engine=getEngine(request,project);
    String format=request.getParameter("format");
    Properties options=getRequestParameters(request);
    Exporter exporter=ExporterRegistry.getExporter(format);
    if (exporter == null) {
      exporter=new CsvExporter('\t');
    }
    response.setCharacterEncoding("UTF-8");
    response.setHeader("Content-Type",exporter.getContentType());
    if (exporter instanceof WriterExporter) {
      PrintWriter writer=response.getWriter();
      ((WriterExporter)exporter).export(project,options,engine,writer);
    }
 else     if (exporter instanceof StreamExporter) {
      ((StreamExporter)exporter).export(project,options,engine,response.getOutputStream());
    }
 else     if (exporter instanceof StreamExporter) {
      ((StreamExporter)exporter).export(project,options,engine,response.getOutputStream());
    }
 else {
      respondException(response,new RuntimeException("Unknown exporter type"));
    }
  }
 catch (  Exception e) {
    respondException(response,e);
  }
 finally {
    ProjectManager.singleton.setBusy(false);
  }
}
