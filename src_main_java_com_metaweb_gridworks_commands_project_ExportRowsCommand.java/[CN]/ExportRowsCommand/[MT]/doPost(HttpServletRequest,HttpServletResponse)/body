{
  ProjectManager.singleton.setBusy(true);
  try {
    Project project=getProject(request);
    Engine engine=getEngine(request,project);
    String format=request.getParameter("format");
    Properties options=getRequestParameters(request);
    Exporter exporter=s_formatToExporter.get(format.toLowerCase());
    if (exporter == null) {
      exporter=new CsvExporter('\t');
    }
    response.setCharacterEncoding("UTF-8");
    response.setHeader("Content-Type",exporter.getContentType());
    if (exporter.takeWriter()) {
      PrintWriter writer=response.getWriter();
      exporter.export(project,options,engine,writer);
    }
 else {
      exporter.export(project,options,engine,response.getOutputStream());
    }
  }
 catch (  Exception e) {
    respondException(response,e);
  }
 finally {
    ProjectManager.singleton.setBusy(false);
  }
}
