{
  long jobID=Long.parseLong(request.getParameter("jobID"));
  ImportJob job=ImportManager.singleton().getJob(jobID);
  Writer w=response.getWriter();
  JSONWriter writer=new JSONWriter(w);
  try {
    writer.object();
    if (job == null) {
      writer.key("code");
      writer.value("error");
      writer.key("message");
      writer.value("No such import job");
    }
 else {
      writer.key("code");
      writer.value("ok");
      writer.key("state");
      if (job.state == State.NEW) {
        writer.value("new");
      }
 else       if (job.state == State.RETRIEVING_DATA) {
        writer.value("retrieving");
        writer.key("progress");
        writer.value(job.retrievingProgress);
        writer.key("bytesSaved");
        writer.value(job.bytesSaved);
      }
 else       if (job.state == State.READY) {
        writer.value("ready");
      }
 else       if (job.state == State.ERROR) {
        writer.value("error");
        writer.key("message");
        writer.value(job.errorMessage);
        if (job.exception != null) {
          StringWriter sw=new StringWriter();
          PrintWriter pw=new PrintWriter(sw);
          job.exception.printStackTrace(pw);
          pw.flush();
          sw.flush();
          writer.key("stack");
          writer.value(sw.toString());
        }
      }
    }
    writer.endObject();
  }
 catch (  JSONException e) {
    throw new IOException(e);
  }
 finally {
    w.flush();
    w.close();
  }
}
