{
  Object o=args[0].evaluate(bindings);
  if (ExpressionUtils.isError(o)) {
    return o;
  }
 else   if (o == null || !o.getClass().isArray()) {
    return new EvalError("First argument to forEach is not an array");
  }
  String name=((VariableExpr)args[1]).getName();
  Object oldValue=bindings.get(name);
  try {
    Object[] values=(Object[])o;
    List<Object> results=new ArrayList<Object>(values.length);
    for (    Object v : values) {
      bindings.put(name,v);
      Object r=args[2].evaluate(bindings);
      results.add(r);
    }
    return results.toArray();
  }
  finally {
    if (oldValue != null) {
      bindings.put(name,oldValue);
    }
 else {
      bindings.remove(name);
    }
  }
}
