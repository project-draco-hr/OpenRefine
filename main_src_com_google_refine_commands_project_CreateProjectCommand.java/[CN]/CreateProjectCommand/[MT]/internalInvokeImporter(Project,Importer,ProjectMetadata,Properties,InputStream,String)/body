{
  if (importer instanceof ReaderImporter) {
    BufferedInputStream inputStream=new BufferedInputStream(rawInputStream);
    byte[] bytes=new byte[1024 * 4];
    inputStream.mark(bytes.length);
    inputStream.read(bytes);
    inputStream.reset();
    CharsetDetector detector=new CharsetDetector();
    detector.setDeclaredEncoding("utf8");
    Reader reader=null;
    CharsetMatch[] charsetMatches=detector.setText(bytes).detectAll();
    for (    CharsetMatch charsetMatch : charsetMatches) {
      try {
        reader=new InputStreamReader(inputStream,charsetMatch.getName());
        options.setProperty("encoding",charsetMatch.getName());
        options.setProperty("encoding_confidence",Integer.toString(charsetMatch.getConfidence()));
        logger.info("Best encoding guess: {} [confidence: {}]",charsetMatch.getName(),charsetMatch.getConfidence());
        break;
      }
 catch (      UnsupportedEncodingException e) {
      }
    }
    if (reader == null) {
      reader=encoding != null ? new InputStreamReader(inputStream,encoding) : new InputStreamReader(inputStream);
    }
    ((ReaderImporter)importer).read(reader,project,metadata,options);
  }
 else {
    ((StreamImporter)importer).read(rawInputStream,project,metadata,options);
  }
}
